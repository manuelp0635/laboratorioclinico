<?php
session_start();
if(!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin'){
    header("Location: ../login.html");
    exit;
}
?>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="/assets/images/PLUS.png" type="image/x-icon">
<title>Laboratorio - Admin</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
/* Reset y base */
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:system-ui, sans-serif;background:#f4f6f9;font-size:16px;color:#333;}

/* Sidebar */
.sidebar{
  width:250px;
  background:#0f172a;
  color:white;
  min-height:100vh;
  position:fixed;
  display:flex;
  flex-direction:column;
  transition:width 0.3s;
  z-index:1000;
}
.sidebar.collapsed{ width:70px; }
.sidebar h5{
  padding:1.25rem;
  text-align:center;
  border-bottom:1px solid #1e293b;
  font-weight:700;
  font-size:1.2rem;
  letter-spacing:1px;
}
.sidebar a{
  display:flex;
  align-items:center;
  gap:10px;
  padding:0.875rem 1.25rem;
  color:#cbd5e1;
  text-decoration:none;
  border-radius:8px;
  transition:0.2s;
  cursor:pointer;
}
.sidebar a:hover,
.sidebar a.active{
  background:#2563eb;
  color:white;
  transform:scale(1.03);
}

/* Topbar */
.topbar{
  background:#1976d2;
  color:white;
  padding:0.75rem 1.25rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:999;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  border-bottom-left-radius:5px;
  border-bottom-right-radius:5px;
}

/* Contenido principal */
.content{
  margin-left:250px;
  padding:1.5rem;
  transition:margin-left 0.3s;
}
.content.collapsed{ margin-left:70px; }

/* Cards y Stat cards */
.card-box{
  background:white;
  border-radius:15px;
  padding:25px;
  box-shadow:0 4px 15px rgba(0,0,0,.05);
  margin-bottom:25px;
  transition:transform 0.2s;
}
.card-box:hover{ transform:translateY(-3px); }

.stat-card{
  border-radius:15px;
  padding:20px;
  color:white;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 4px 15px rgba(0,0,0,0.1);
  transition:transform 0.2s, box-shadow 0.2s;
}
.stat-card:hover{
  transform:translateY(-5px);
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
}

/* Colores */
.bg1{background:linear-gradient(135deg,#0d3b66,#07407c);}
.bg2{background:linear-gradient(135deg,#6c757d,#5a6268);}
.bg3{background:linear-gradient(135deg,#0d6efd,#025ce2);}
.bg4{background:linear-gradient(135deg,#d63384,#b52a6f);}
.bg5{background:linear-gradient(135deg,#198754,#146c43);}
.bg6{background:linear-gradient(135deg,#fd7e14,#e76f00);}

/* Secciones */
.section{ display:none; }
.section.active{ display:block; }

/* Grid de cards */
.cards-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:1.5rem;
}

/* Responsive */
@media (max-width:1024px){
  .sidebar{ width:200px; }
  .content{ margin-left:200px; }
}
@media (max-width:768px){
  .sidebar{ width:60px; overflow-x:hidden; }
  .sidebar:hover{ width:180px; }
  .content{ margin-left:60px; padding:1rem; }
}
@media (max-width:480px){
  .sidebar{ width:0; transition:width 0.3s; }
  .sidebar.show{ width:180px; }
  .content{ margin-left:0; padding:0.75rem; }
  .topbar{ flex-direction:column; align-items:flex-start; gap:0.5rem; }
}

/* Sidebar responsive */
@media (max-width:768px){
  .sidebar{
    width:0;
    overflow-x:hidden;
    position:fixed;
    left:0;
    top:0;
    height:100%;
    transition:width 0.3s;
  }
  .sidebar.show{
    width:200px; /* ancho visible en móvil */
  }
  .content{
    margin-left:0;
    padding:1rem;
    transition:margin-left 0.3s;
  }
}

/* Evita que el sidebar desborde */
body{
  overflow-x:hidden;
}

</style>
</head>

<body>

<div class="sidebar" id="sidebar">
<h5>Plus Laboratorio Clínico</h5>

<a class="active" onclick="showSection('dashboard',this)">
<i class="bi bi-speedometer2"></i> Dashboard
</a>

<a onclick="showSection('citas',this)">
<i class="bi bi-calendar-event"></i> Lista de Citas
</a>

<a onclick="showSection('usuarios_registrados',this)">
<i class="bi bi-people"></i> Usuarios Registrados
</a>

<a onclick="showSection('pruebas',this)">
<i class="bi bi-clipboard2-pulse"></i> Lista de Pruebas
</a>

<a onclick="showSection('usuarios',this)">
<i class="bi bi-person-lines-fill"></i> Lista de Usuarios
</a>

<a onclick="showSection('configuracion',this)">
<i class="bi bi-gear"></i> Configuraciones del Sistema
</a>

<a href="../api/logout.php" onclick="logout()">
<i class="bi bi-box-arrow-right"></i> Salir
</a>

</div>

<div class="content">

<div class="topbar">
<div><button id="toggleSidebar">☰</button> Plus Laboratorio Clínico Cartagena - Admin</div>
<div>Administrador</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="section active mt-4">
<h2>Bienvenido al Laboratorio</h2>
<hr>
<div class="row g-4 mt-3">
<div class="col-md-4">
<div class="stat-card bg1">
<div><h6>Tests</h6><h4 id="totalTests">0</h4></div>
<i class="bi bi-grid fs-1"></i>
</div></div>
<div class="col-md-4">
<div class="stat-card bg2">
<div><h6>Citas Reservadas</h6><h4 id="citasReservadas">0</h4></div>
<i class="bi bi-calendar-event fs-1"></i>
</div></div>
<div class="col-md-4">
<div class="stat-card bg3">
<div><h6>Citas Pendientes</h6><h4 id="citasPendientes">0</h4></div>
<i class="bi bi-hourglass-split fs-1"></i>
</div></div>
<div class="col-md-4">
<div class="stat-card bg4">
<div><h6>Citas Aprobadas</h6><h4 id="citasAprobadas">0</h4></div>
<i class="bi bi-hand-thumbs-up fs-1"></i>
</div></div>
<div class="col-md-4">
<div class="stat-card bg5">
<div><h6>Pruebas Terminadas</h6><h4 id="pruebasTerminadas">0</h4></div>
<i class="bi bi-check-circle fs-1"></i>
</div></div>
<div class="col-md-4">
<div class="stat-card bg6">
<div><h6>Usuarios Registrados</h6><h4 id="usuariosRegistrados">0</h4></div>
<i class="bi bi-people fs-1"></i>
</div></div>
</div>
</div>

<!-- CITAS -->
<div id="citas" class="section mt-4">
<div class="card-box">
<h4>Lista de Citas</h4>
<table class="table">
<thead><tr><th>Paciente</th><th>Fecha</th><th>Estado</th><th>Acción</th></tr></thead>
<tbody id="tablaCitas"></tbody>
</table>
</div>
</div>

<!-- USUARIOS REGISTRADOS -->
<div id="usuarios_registrados" class="section mt-4">
<div class="card-box">
<h4>Usuarios Registrados</h4>
<table class="table">
<thead><tr><th>Nombre</th><th>Email</th><th>Rol</th></tr></thead>
<tbody id="tablaUsuariosRegistrados"></tbody>
</table>
</div>
</div>

<!-- PRUEBAS -->
<div id="pruebas" class="section mt-4">
<div class="card-box">
<h4>Lista de Pruebas</h4>
<table class="table">
<thead><tr><th>Nombre</th><th>Rango Min</th><th>Rango Max</th></tr></thead>
<tbody id="tablaPruebas"></tbody>
</table>
</div>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="section mt-4">
<div class="card-box">
<h4>Lista de Usuarios</h4>
<table class="table">
<thead><tr><th>Nombre</th><th>Rol</th><th>Permisos</th></tr></thead>
<tbody id="tablaUsuarios"></tbody>
</table>
</div>
</div>

<!-- CONFIGURACION -->
<div id="configuracion" class="section mt-4">
<div class="card-box">
<h4>Configuraciones del Sistema</h4>
<p>Aquí puedes configurar parámetros globales.</p>
</div>
</div>

</div>

<script>

  

/* Toggle sidebar móvil */
const toggleBtn = document.getElementById('toggleSidebar');
const sidebar = document.getElementById('sidebar');
toggleBtn.addEventListener('click',()=>sidebar.classList.toggle('show'));

/* Mostrar sección */
function showSection(id,el){
document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
el.classList.add("active");
sidebar.classList.remove("show");
}

/* Logout */
async function logout(){
await fetch("../api/logout.php",{method:"POST",credentials:"include"});
window.location.href="../login.html";
}

/* Carga datos Dashboard */
async function cargarDashboard(){
const res=await fetch("../api/admin_dashboard.php");
if(!res.ok)return;
const data=await res.json();
totalTests.innerText=data.tests||0;
citasReservadas.innerText=data.reservadas||0;
citasPendientes.innerText=data.pendientes||0;
citasAprobadas.innerText=data.aprobadas||0;
pruebasTerminadas.innerText=data.terminadas||0;
usuariosRegistrados.innerText=data.usuarios||0;
}

/* Carga usuarios */
async function cargarUsuarios(){
const res=await fetch("../api/get_usuarios.php");
if(!res.ok)return;
const data=await res.json();
tablaUsuarios.innerHTML=data.map(u=>`
<tr><td>${u.nombre}</td><td>${u.role}</td><td>${u.permissions}</td></tr>
`).join("");
}

document.addEventListener("DOMContentLoaded",()=>{
cargarDashboard();
cargarUsuarios();
});
</script>

</body>
</html>
