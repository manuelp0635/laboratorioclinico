<?php
session_start();
if(!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin'){
    header("Location: ../login.html");
    exit;
}
?>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laboratorio - Admin</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
body{
margin:0;
font-family:system-ui;
background:#f4f6f9;
}

.sidebar{
width:250px;
background:#0f172a;
color:white;
min-height:100vh;
position:fixed;
}

.sidebar h5{
padding:20px;
margin:0;
text-align:center;
border-bottom:1px solid #1e293b;
}

.sidebar a{
display:block;
padding:14px 20px;
color:#cbd5e1;
text-decoration:none;
cursor:pointer;
}

.sidebar a:hover,
.sidebar .active{
background:#2563eb;
color:white;
}

.content{
margin-left:250px;
padding:25px;
}

.topbar{
background:#1976d2;
color:white;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
}

.section{
display:none;
}

.section.active{
display:block;
}

.card-box{
background:white;
border-radius:12px;
padding:20px;
box-shadow:0 2px 10px rgba(0,0,0,.05);
margin-bottom:20px;
}

.stat-card{
border-radius:15px;
padding:20px;
color:white;
display:flex;
justify-content:space-between;
align-items:center;
}

.bg1{background:#0d3b66}
.bg2{background:#6c757d}
.bg3{background:#0d6efd}
.bg4{background:#d63384}
.bg5{background:#198754}
.bg6{background:#fd7e14}
</style>
</head>

<body>

<div class="sidebar">
<h5>Plus Laboratorio Clinico</h5>

<a class="active" onclick="showSection('dashboard',this)">
<i class="bi bi-speedometer2"></i> Dashboard
</a>

<a onclick="showSection('citas',this)">
<i class="bi bi-calendar-event"></i> Lista de Citas
</a>

<a onclick="showSection('usuarios_registrados',this)">
<i class="bi bi-people"></i> Usuarios Registrados
</a>

<a onclick="showSection('pruebas',this)">
<i class="bi bi-clipboard2-pulse"></i> Lista de Pruebas
</a>

<a onclick="showSection('usuarios',this)">
<i class="bi bi-person-lines-fill"></i> Lista de Usuarios
</a>

<a onclick="showSection('configuracion',this)">
<i class="bi bi-gear"></i> Configuraciones del Sistema
</a>

<a href="../api/logout.php" onclick="logout()">
<i class="bi bi-box-arrow-right"></i> Salir
</a>

</div>

<div class="content">

<div class="topbar">
<div>Plus Labotario Clinico Cartagena - Admin</div>
<div>Administrador</div>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard" class="section active mt-4">

<h2>Bienvenido al Laboratorio</h2>
<hr>

<div class="row g-4 mt-3">

<div class="col-md-4">
<div class="stat-card bg1">
<div>
<h6>Tests</h6>
<h4 id="totalTests">0</h4>
</div>
<i class="bi bi-grid fs-1"></i>
</div>
</div>

<div class="col-md-4">
<div class="stat-card bg2">
<div>
<h6>Citas Reservadas</h6>
<h4 id="citasReservadas">0</h4>
</div>
<i class="bi bi-calendar-event fs-1"></i>
</div>
</div>

<div class="col-md-4">
<div class="stat-card bg3">
<div>
<h6>Citas Pendientes</h6>
<h4 id="citasPendientes">0</h4>
</div>
<i class="bi bi-hourglass-split fs-1"></i>
</div>
</div>

<div class="col-md-4">
<div class="stat-card bg4">
<div>
<h6>Citas Aprobadas</h6>
<h4 id="citasAprobadas">0</h4>
</div>
<i class="bi bi-hand-thumbs-up fs-1"></i>
</div>
</div>

<div class="col-md-4">
<div class="stat-card bg5">
<div>
<h6>Pruebas Terminadas</h6>
<h4 id="pruebasTerminadas">0</h4>
</div>
<i class="bi bi-check-circle fs-1"></i>
</div>
</div>

<div class="col-md-4">
<div class="stat-card bg6">
<div>
<h6>Usuarios Registrados</h6>
<h4 id="usuariosRegistrados">0</h4>
</div>
<i class="bi bi-people fs-1"></i>
</div>
</div>

</div>
</div>

<!-- ================= CITAS ================= -->
<div id="citas" class="section mt-4">
<div class="card-box">
<h4>Lista de Citas</h4>
<table class="table">
<thead>
<tr>
<th>Paciente</th>
<th>Fecha</th>
<th>Estado</th>
<th>Acción</th>
</tr>
</thead>
<tbody id="tablaCitas"></tbody>
</table>
</div>
</div>

<!-- ================= USUARIOS REGISTRADOS ================= -->
<div id="usuarios_registrados" class="section mt-4">
<div class="card-box">
<h4>Usuarios Registrados</h4>
<table class="table">
<thead>
<tr>
<th>Nombre</th>
<th>Email</th>
<th>Rol</th>
</tr>
</thead>
<tbody id="tablaUsuariosRegistrados"></tbody>
</table>
</div>
</div>

<!-- ================= PRUEBAS ================= -->
<div id="pruebas" class="section mt-4">
<div class="card-box">
<h4>Lista de Pruebas</h4>
<table class="table">
<thead>
<tr>
<th>Nombre</th>
<th>Rango Min</th>
<th>Rango Max</th>
</tr>
</thead>
<tbody id="tablaPruebas"></tbody>
</table>
</div>
</div>

<!-- ================= USUARIOS ================= -->
<div id="usuarios" class="section mt-4">
<div class="card-box">
<h4>Lista de Usuarios</h4>
<table class="table">
<thead>
<tr>
<th>Nombre</th>
<th>Rol</th>
<th>Permisos</th>
</tr>
</thead>
<tbody id="tablaUsuarios"></tbody>
</table>
</div>
</div>

<!-- ================= CONFIGURACION ================= -->
<div id="configuracion" class="section mt-4">
<div class="card-box">
<h4>Configuraciones del Sistema</h4>
<p>Aquí puedes configurar parámetros globales.</p>
</div>
</div>

</div>

<script>

    /* logout sesion */

    async function logout(){
    await fetch("../api/logout.php",{
        method:"POST",
        credentials:"include"
    });
    window.location.href="../login.html";
}


function showSection(id,element){
document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");

document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
element.classList.add("active");
}

/* ================= CARGA DATOS ================= */

async function cargarDashboard(){
const res=await fetch("../api/admin_dashboard.php");
if(!res.ok)return;
const data=await res.json();

totalTests.innerText=data.tests||0;
citasReservadas.innerText=data.reservadas||0;
citasPendientes.innerText=data.pendientes||0;
citasAprobadas.innerText=data.aprobadas||0;
pruebasTerminadas.innerText=data.terminadas||0;
usuariosRegistrados.innerText=data.usuarios||0;
}

async function cargarUsuarios(){
const res=await fetch("../api/get_usuarios.php");
if(!res.ok)return;
const data=await res.json();
tablaUsuarios.innerHTML=data.map(u=>`
<tr>
<td>${u.nombre}</td>
<td>${u.role}</td>
<td>${u.permissions}</td>
</tr>
`).join("");
}

document.addEventListener("DOMContentLoaded",()=>{
cargarDashboard();
cargarUsuarios();
});

</script>

</body>
</html>
