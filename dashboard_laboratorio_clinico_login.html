<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | Plus Laboratorio Cl√≠nico</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  /* =================================================
   1. RESET GLOBAL & CONTROL DE EJES
   ================================================= */
*,
*::before,
*::after{
  box-sizing:border-box;
}

html, body{
  width:100%;
  max-width:100%;
  margin:0;
  padding:0;
  overflow-x:hidden;
}

body{
  background:#f4f6f9;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  position:relative;
}

/* Evita empujes en flex */
.d-flex,
.flex-fill,
.row{
  min-width:0;
  max-width:100%;
}

/* Medios nunca desbordan */
img,
svg,
canvas,
video{
  max-width:100%;
  height:auto;
  display:block;
}

/* =================================================
   2. UTILIDADES GENERALES
   ================================================= */
.hidden{display:none}

/* =================================================
   3. CONTENEDORES PRINCIPALES
   ================================================= */
.flex-fill{
  width:100%;
  max-width:100%;
  padding:1.5rem;
  overflow-x:hidden;
}

.card{
  width:100%;
  max-width:100%;
  border-radius:18px;
  border:none;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
}

/* =================================================
   4. SIDEBAR (DESKTOP BASE)
   ================================================= */
.sidebar{
  width:260px;
  min-height:100vh;
  background:linear-gradient(180deg,#111827,#1f2937);
  color:#fff;
  transition:transform .3s ease;
  z-index:1000;
  flex-shrink:0;
}

.sidebar h4{
  font-weight:700;
}

.sidebar a{
  color:#cbd5e1;
  text-decoration:none;
  display:flex;
  align-items:center;
  gap:8px;
  padding:12px 20px;
  border-radius:10px;
  margin:4px 10px;
  transition:.3s;
}

.sidebar a:hover,
.sidebar a.active{
  background:#2563eb;
  color:#fff;
}

/* =================================================
   5. BOT√ìN HAMBURGUESA
   ================================================= */
.menu-toggle{
  display:none;
  position:fixed;
  top:14px;
  left:14px;
  background:#2563eb;
  border:none;
  border-radius:10px;
  padding:10px 12px;
  z-index:1200;
  box-shadow:0 6px 15px rgba(0,0,0,.25);
}

.menu-toggle span{
  display:block;
  width:22px;
  height:2px;
  background:#fff;
  margin:5px 0;
}

/* =================================================
   6. OVERLAY
   ================================================= */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  opacity:0;
  pointer-events:none;
  transition:.3s;
  z-index:900;
}

.overlay.active{
  opacity:1;
  pointer-events:auto;
}

/* =================================================
   7. BOTONES
   ================================================= */
.btn{
  width:auto;
  max-width:100%;
  border-radius:12px;
  font-weight:600;
  transition:.3s ease;
  box-shadow:0 6px 15px rgba(0,0,0,.08);
}

.btn:hover{transform:translateY(-2px)}
.btn:active{transform:scale(.97)}

.btn-primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);border:none}
.btn-success{background:linear-gradient(135deg,#16a34a,#15803d);border:none}
.btn-danger{background:linear-gradient(135deg,#dc2626,#b91c1c);border:none}
.btn-warning{background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:#000}
.btn-secondary{background:linear-gradient(135deg,#6b7280,#4b5563);border:none}

/* =================================================
   8. TABLAS
   ================================================= */
.table{
  width:100%;
  max-width:100%;
  background:#fff;
  border-radius:14px;
}

.table-responsive{
  width:100%;
  max-width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}

/* =================================================
   9. CHARTS / CANVAS (CONTROL EJE X)
   ================================================= */
canvas{
  width:100% !important;
  max-width:100%;
  height:auto !important;
}

/* =================================================
   10. RESPONSIVE ‚Äî TABLET
   ================================================= */
@media (max-width:992px){
  .sidebar{
    width:220px;
  }
}

/* =================================================
   11. RESPONSIVE ‚Äî MOBILE
   ================================================= */
@media (max-width:768px){

  /* Hamburguesa visible */
  .menu-toggle{
    display:block;
  }

  /* Sidebar off-canvas */
  .sidebar{
    position:fixed;
    top:0;
    left:0;
    height:100vh;
    max-width:85vw;
    transform:translateX(-100%);
  }

  .sidebar.active{
    transform:translateX(0);
  }

  /* Contenido baja para no tapar header */
  .flex-fill{
    padding-top:80px !important;
    padding-left:1rem;
    padding-right:1rem;
  }

  /* Layout vertical */
  .d-flex{
    flex-direction:column;
  }

  /* Botones t√°ctiles */
  .btn{
    width:100%;
  }
}

/* =================================================
   12. SMALL MOBILE
   ================================================= */
@media (max-width:480px){
  .sidebar{
    max-width:90vw;
  }

  .flex-fill{
    padding-top:90px !important;
  }
}
</style>
</head>

<body>

  <button class="menu-toggle" onclick="toggleMenu()">
  <span></span>
  <span></span>
  <span></span>
</button>

<div class="overlay" onclick="toggleMenu()"></div>

<div class="d-flex">

<!-- SIDEBAR -->
<div class="sidebar">
<h4 class="text-center py-4">üî¨ Plus Lab</h4>
<a onclick="showSection('dashboard',this)" class="active">üìä Dashboard</a>
<a onclick="showSection('citas',this)">üìÖ Citas</a>
<a onclick="showSection('usuarios',this)">üë• Usuarios</a>
<a onclick="showSection('pruebas',this)">üß™ Pruebas</a>
<a onclick="showSection('reportes',this)">üìä Reportes</a>
<a onclick="showSection('config',this)">‚öôÔ∏è Configuraci√≥n</a>
<a onclick="exportarPDF()">üìÑ Exportar PDF</a>
<a onclick="logout()">üö™ Cerrar sesi√≥n</a>
</div>

<!-- CONTENIDO -->
<div class="flex-fill p-4">

<!-- DASHBOARD -->
<div id="dashboard" class="section">
<h3 class="fw-bold">Bienvenido</h3>
<p id="infoUser"></p>

<div class="card p-4 mb-3">
<h6 class="fw-bold">üö® Notificaciones</h6>
<div class="d-flex gap-2 flex-wrap">
<button class="btn btn-success" onclick="notificar('success','Proceso exitoso')">‚úî Success</button>
<button class="btn btn-danger" onclick="notificar('danger','Registro eliminado')">üóë Eliminar</button>
<button class="btn btn-warning" onclick="notificar('warning','Registro modificado')">‚úè Modificar</button>
</div>
</div>

<div class="card p-4 mb-3">
<h6 class="fw-bold">üßæ Historial</h6>
<ul id="historial" class="list-group list-group-flush"></ul>
</div>

<div class="row">
<div class="col-md-6"><canvas id="chartResultados"></canvas></div>
<div class="col-md-6"><canvas id="chartTipos"></canvas></div>
</div>
</div>

<!-- CITAS -->
<div id="citas" class="section hidden">
<h4 class="fw-bold">üìÖ Citas</h4>
<button class="btn btn-primary mb-3" onclick="crearCita()">‚ûï Nueva Cita</button>
<table class="table"><tbody id="tablaCitas"></tbody></table>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="section hidden">
<h4 class="fw-bold">üë• Usuarios</h4>
<button class="btn btn-primary mb-3" onclick="crearUsuario()">‚ûï Nuevo Usuario</button>
<table class="table"><tbody id="tablaUsuarios"></tbody></table>
</div>

<!-- PRUEBAS -->
<div id="pruebas" class="section hidden">
<h4 class="fw-bold">üß™ Pruebas</h4>
<button class="btn btn-success mb-3" onclick="crearPrueba()">‚ûï Nueva Prueba</button>
<ul id="listaPruebas" class="list-group"></ul>
</div>

<!-- REPORTES -->
<div id="reportes" class="section hidden">
<div class="card p-4">
<h4 class="fw-bold">üìä Reportes Avanzados</h4>
<div class="row g-3 mb-3">
<div class="col-md-3">
<select id="filtroTipo" class="form-select">
<option value="">Todos</option>
<option value="cita">Citas</option>
<option value="prueba">Pruebas</option>
</select>
</div>
<div class="col-md-3">
<input type="date" id="filtroFecha" class="form-control">
</div>
<div class="col-md-3">
<button class="btn btn-primary w-100" onclick="generarReporte()">Generar</button>
</div>
<div class="col-md-3">
<button class="btn btn-danger w-100" onclick="exportarReportePDF()">PDF</button>
</div>
</div>
<table class="table">
<thead>
<tr><th>Tipo</th><th>Detalle</th><th>Fecha</th><th>Lab</th><th>Usuario</th></tr>
</thead>
<tbody id="tablaReportes"></tbody>
</table>
</div>
</div>

<!-- CONFIG -->
<div id="config" class="section hidden">
<h4 class="fw-bold">‚öôÔ∏è Configuraci√≥n</h4>
<button class="btn btn-secondary" onclick="notificar('warning','Configuraci√≥n guardada')">Guardar</button>
</div>

</div>
</div>

<!-- TOAST -->
<div class="toast-container position-fixed top-0 end-0 p-3">
<div id="toast" class="toast text-white">
<div class="toast-body" id="toastMsg"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= AUTH ================= */
let user = null;

// Validar sesi√≥n al cargar
document.addEventListener("DOMContentLoaded", () => {
  const storedUser = localStorage.getItem("user");

  if (!storedUser) {
    window.location.replace("login.html");
    return;
  }

  try {
    user = JSON.parse(storedUser);
  } catch (e) {
    localStorage.removeItem("user");
    window.location.replace("login.html");
    return;
  }

  // Mostrar info del usuario
  document.getElementById("infoUser").innerText =
    `Usuario: ${user.nombre} | Rol: ${user.rol} | Lab: ${user.lab}`;

  renderHistorial();
});

// Logout seguro
function logout() {
  localStorage.removeItem("user");
  sessionStorage.clear();
  window.location.replace("login.html");
}

/* ================= ROLES ================= */
const PERMISOS = {
  admin: ['dashboard','citas','usuarios','pruebas','reportes','config'],
  staff: ['dashboard','citas','pruebas','reportes']
};

function showSection(id, el) {
  if (!user || !PERMISOS[user.rol]?.includes(id)) {
    return notificar('danger', 'Acceso denegado');
  }

  document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');

  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
  el.classList.add('active');
}

/* ================= TOAST ================= */
function notificar(tipo, msg) {
  const toast = document.getElementById("toast");
  const toastMsg = document.getElementById("toastMsg");

  toast.className = `toast toast-${tipo} text-white`;
  toastMsg.innerText = msg;

  guardarHistorial(msg);
  new bootstrap.Toast(toast, { delay: 2200 }).show();
}

/* ================= HISTORIAL ================= */
function guardarHistorial(msg) {
  const h = JSON.parse(localStorage.getItem('historial')) || [];
  h.unshift({
    msg,
    fecha: new Date().toLocaleString(),
    user: user?.nombre || "Sistema"
  });
  localStorage.setItem('historial', JSON.stringify(h.slice(0, 20)));
  renderHistorial();
}

function renderHistorial() {
  const historial = document.getElementById("historial");
  if (!historial) return;

  historial.innerHTML = '';
  (JSON.parse(localStorage.getItem('historial')) || []).forEach(i => {
    historial.innerHTML += `
      <li class="list-group-item">
        ${i.msg}<br>
        <small>${i.fecha} - ${i.user}</small>
      </li>`;
  });
}

/* ================= API ================= */
const API = {
  get: k => JSON.parse(localStorage.getItem(k)) || [],
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
};

let citas = API.get('citas');
let usuarios = API.get('usuarios');
let pruebas = API.get('pruebas');

/* ================= CRUD ================= */
function crearCita() {
  citas.push({
    paciente: prompt('Paciente'),
    fecha: prompt('Fecha'),
    lab: user.lab
  });
  API.set('citas', citas);
  notificar('success', 'Cita creada');
}

function crearUsuario() {
  usuarios.push({
    nombre: prompt('Nombre'),
    rol: prompt('Rol'),
    lab: prompt('Lab')
  });
  API.set('usuarios', usuarios);
  notificar('success', 'Usuario creado');
}

function crearPrueba() {
  pruebas.push(prompt('Prueba'));
  API.set('pruebas', pruebas);
  notificar('success', 'Prueba creada');
}

/* ================= REPORTES ================= */
function generarReporte() {
  const t = filtroTipo.value;
  const f = filtroFecha.value;
  let d = [];

  citas.forEach(c =>
    d.push({
      tipo: 'Cita',
      detalle: c.paciente,
      fecha: c.fecha,
      lab: c.lab,
      usuario: user.nombre
    })
  );

  pruebas.forEach(p =>
    d.push({
      tipo: 'Prueba',
      detalle: p,
      fecha: '-',
      lab: user.lab,
      usuario: user.nombre
    })
  );

  d = d.filter(r =>
    (!t || r.tipo.toLowerCase().includes(t)) &&
    (!f || r.fecha === f)
  );

  tablaReportes.innerHTML = d.length
    ? d.map(r =>
        `<tr>
          <td>${r.tipo}</td>
          <td>${r.detalle}</td>
          <td>${r.fecha}</td>
          <td>${r.lab}</td>
          <td>${r.usuario}</td>
        </tr>`
      ).join('')
    : `<tr><td colspan="5" class="text-center">Sin resultados</td></tr>`;
}

function exportarReportePDF() {
  html2pdf().from(document.getElementById('reportes')).save('reporte.pdf');
}

/* ================= CHARTS ================= */
new Chart(chartResultados, {
  type: 'line',
  data: {
    labels: ['L', 'M', 'X', 'J', 'V'],
    datasets: [{ data: [10, 20, 15, 25, 30] }]
  }
});

new Chart(chartTipos, {
  type: 'doughnut',
  data: {
    labels: ['Hemo', 'Glu', 'Col'],
    datasets: [{ data: [40, 35, 25] }]
  }
});
</script>

<script>
  function toggleMenu(){
    document.querySelector('.sidebar').classList.toggle('active');
    document.querySelector('.overlay').classList.toggle('active');
  }
</script>

</body>
</html>
