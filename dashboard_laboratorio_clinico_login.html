<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | Plus Laboratorio Cl√≠nico</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#f4f6f9;font-family:system-ui}
.hidden{display:none}

.sidebar{
width:260px;
min-height:100vh;
background:#111827;
color:#fff;
transition:.3s;
}

.sidebar a{
display:block;
color:#cbd5e1;
padding:14px 18px;
text-decoration:none;
border-radius:10px;
margin:6px;
cursor:pointer;
}

.sidebar a:hover,.active{background:#2563eb;color:#fff}

.flex-fill{padding:1.5rem;width:100%}

.card{
border:none;
border-radius:18px;
box-shadow:0 10px 25px rgba(0,0,0,.05);
margin-bottom:1rem;
}

.menu-toggle{
display:none;
position:fixed;
top:15px;
left:15px;
background:#2563eb;
border:none;
border-radius:10px;
padding:10px;
z-index:2000;
}

.menu-toggle span{
display:block;
width:22px;
height:2px;
background:#fff;
margin:4px 0;
}

.overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,.4);
opacity:0;
pointer-events:none;
transition:.3s;
}

.overlay.active{
opacity:1;
pointer-events:auto;
}

@media(max-width:768px){

.menu-toggle{display:block}

.sidebar{
position:fixed;
transform:translateX(-100%);
z-index:1500;
}

.sidebar.active{
transform:translateX(0);
}

.flex-fill{
padding-top:80px;
}

}
</style>
</head>

<body>

<button class="menu-toggle" onclick="toggleMenu()">
<span></span>
<span></span>
<span></span>
</button>

<div class="overlay" onclick="toggleMenu()"></div>

<div class="d-flex">

<!-- SIDEBAR DIN√ÅMICO -->
<div class="sidebar"></div>

<!-- CONTENIDO -->
<div class="flex-fill">

<!-- DASHBOARD -->
<div id="dashboard" class="section">
<div class="card p-4">
<h3>Bienvenido</h3>
<div id="infoUser"></div>
</div>

<div class="row">
<div class="col-lg-6">
<div class="card p-3">
<h6>Tipos de pruebas</h6>
<canvas id="chartTipos"></canvas>
</div>
</div>

<div class="col-lg-6">
<div class="card p-3">
<h6>Resultados semanales</h6>
<canvas id="chartResultados"></canvas>
</div>
</div>
</div>
</div>

<!-- CITAS -->
<div id="citas" class="section hidden">
<h4>Citas</h4>
<button class="btn btn-primary mb-2" onclick="crearCita()">Nueva cita</button>
<table class="table"><tbody id="tablaCitas"></tbody></table>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="section hidden">
<h4>Usuarios</h4>
<button class="btn btn-primary mb-2" onclick="crearUsuario()">Nuevo usuario</button>
<table class="table"><tbody id="tablaUsuarios"></tbody></table>
</div>

<!-- PRUEBAS -->
<div id="pruebas" class="section hidden">
<h4>Pruebas</h4>
<button class="btn btn-success mb-2" onclick="crearPrueba()">Nueva prueba</button>
<ul id="listaPruebas" class="list-group"></ul>
</div>

<!-- REPORTES -->
<div id="reportes" class="section hidden">
<h4>Reportes</h4>
<button class="btn btn-danger" onclick="exportarReportePDF()">Exportar PDF</button>
</div>

<!-- CONFIG -->
<div id="config" class="section hidden">
<h4>Configuraci√≥n</h4>
</div>

<!-- RESULTADOS PACIENTE -->
<div id="misResultados" class="section hidden">
<div class="card p-4">
<h4>Mis Resultados</h4>
<table class="table">
<thead>
<tr>
<th>Prueba</th>
<th>Fecha</th>
<th>Laboratorio</th>
<th>Descargar</th>
</tr>
</thead>
<tbody id="tablaResultadosPaciente"></tbody>
</table>
</div>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

/* ================= MENU ================= */

function toggleMenu(){
document.querySelector(".sidebar").classList.toggle("active");
document.querySelector(".overlay").classList.toggle("active");
}

/* ================= AUTH ================= */

let user=null;

document.addEventListener("DOMContentLoaded",()=>{

const storedUser=localStorage.getItem("user");

if(!storedUser){
window.location.replace("login.html");
return;
}

user=JSON.parse(storedUser);

document.getElementById("infoUser").innerText=
`Usuario: ${user.nombre} | Rol: ${user.rol} | Lab: ${user.lab}`;

generarSidebar();

/* paciente directo */
if(user.rol==="paciente"){
showSection("misResultados");
renderResultadosPaciente();
}else{
showSection("dashboard");
}

/* charts seguros */
initCharts();

});

/* ================= LOGOUT ================= */

function logout(){
localStorage.removeItem("user");
window.location.replace("login.html");
}

/* ================= SIDEBAR ================= */

const PERMISOS={
admin:['dashboard','citas','usuarios','pruebas','reportes','config'],
staff:['dashboard','citas','pruebas','reportes'],
paciente:['misResultados']
};

function generarSidebar(){

const sidebar=document.querySelector(".sidebar");

sidebar.innerHTML=`<h4 class="text-center py-4">üî¨ Plus Lab</h4>`;

const menus={
admin:[
["üìä Dashboard","dashboard"],
["üìÖ Citas","citas"],
["üë• Usuarios","usuarios"],
["üß™ Pruebas","pruebas"],
["üìä Reportes","reportes"],
["‚öôÔ∏è Configuraci√≥n","config"]
],
staff:[
["üìä Dashboard","dashboard"],
["üìÖ Citas","citas"],
["üß™ Pruebas","pruebas"],
["üìä Reportes","reportes"]
],
paciente:[
["üìÑ Mis Resultados","misResultados"]
]
};

menus[user.rol].forEach(item=>{
const a=document.createElement("a");
a.innerText=item[0];
a.onclick=()=>showSection(item[1],a);
sidebar.appendChild(a);
});

const logoutBtn=document.createElement("a");
logoutBtn.innerText="üö™ Cerrar sesi√≥n";
logoutBtn.onclick=logout;
sidebar.appendChild(logoutBtn);

}

/* ================= SECCIONES ================= */

function showSection(id,el){

if(!PERMISOS[user.rol].includes(id)) return;

document.querySelectorAll('.section')
.forEach(s=>s.classList.add('hidden'));

document.getElementById(id).classList.remove('hidden');

document.querySelectorAll('.sidebar a')
.forEach(a=>a.classList.remove('active'));

el?.classList.add('active');

}

/* ================= RESULTADOS ================= */

function renderResultadosPaciente(){

const tabla=document.getElementById("tablaResultadosPaciente");

const resultados=
JSON.parse(localStorage.getItem('resultados'))||[];

const mis=resultados.filter(r=>r.pacienteId===user.id);

if(!mis.length){
tabla.innerHTML=`<tr>
<td colspan="4" class="text-center">Sin resultados</td>
</tr>`;
return;
}

tabla.innerHTML=mis.map(r=>`
<tr>
<td>${r.prueba}</td>
<td>${r.fecha}</td>
<td>${r.lab}</td>
<td>
<button class="btn btn-primary btn-sm"
onclick="descargarArchivo('${r.archivo}')">
Descargar
</button>
</td>
</tr>
`).join('');
}

function descargarArchivo(nombre){

const link=document.createElement("a");
link.href="resultados/"+nombre;
link.download=nombre;
link.click();

}

/* ================= CRUD SIMPLE ================= */

const API={
get:k=>JSON.parse(localStorage.getItem(k))||[],
set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};

let citas=API.get('citas');
let usuarios=API.get('usuarios');
let pruebas=API.get('pruebas');

function crearCita(){

citas.push({
paciente:prompt("Paciente"),
fecha:prompt("Fecha"),
lab:user.lab
});

API.set('citas',citas);
alert("Cita creada");

}

function crearUsuario(){

const rol=prompt("Rol: admin / staff / paciente");

if(!['admin','staff','paciente'].includes(rol)){
alert("Rol inv√°lido");
return;
}

usuarios.push({
id:crypto.randomUUID(),
nombre:prompt("Nombre"),
rol,
lab:prompt("Lab")
});

API.set('usuarios',usuarios);
alert("Usuario creado");

}

function crearPrueba(){

pruebas.push(prompt("Nombre prueba"));
API.set('pruebas',pruebas);

}

/* ================= CHARTS ================= */

function initCharts(){

const ctx1=document.getElementById("chartResultados");
const ctx2=document.getElementById("chartTipos");

if(ctx1){
new Chart(ctx1,{
type:'line',
data:{
labels:['L','M','X','J','V'],
datasets:[{data:[12,22,26,30,41],tension:.4,fill:true}]
},
options:{plugins:{legend:{display:false}},responsive:true}
});
}

if(ctx2){
new Chart(ctx2,{
type:'doughnut',
data:{
labels:['Hematolog√≠a','Bioqu√≠mica','Otros'],
datasets:[{data:[45,30,25],borderWidth:0}]
},
options:{plugins:{legend:{position:'bottom'}},cutout:'68%'}
});
}

}

function exportarReportePDF(){
html2pdf().from(document.body).save('reporte.pdf');
}

</script>

</body>
</html>
