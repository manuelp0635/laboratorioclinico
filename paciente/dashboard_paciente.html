<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="/assets/images/PLUS.png" type="image/x-icon">
<title>Laboratorio | Paciente</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* Reset y base */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
  font-family: system-ui, sans-serif;
  background: #f4f6f9;
  font-size: 16px;
  color: #333;
  overflow-x: hidden; /* evita overflow por sidebar */
}

/* Sidebar */
.sidebar {
  width: 250px;
  background: #0f172a;
  color: white;
  min-height: 100vh;
  position: fixed;
  display: flex;
  flex-direction: column;
  transition: width 0.3s;
  z-index: 1000;
}
.sidebar.collapsed { width: 70px; }
.sidebar h5 {
  padding: 1.25rem;
  text-align: center;
  border-bottom: 1px solid #1e293b;
  font-weight: 700;
  font-size: 1.2rem;
  letter-spacing: 1px;
}
.sidebar a {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0.875rem 1.25rem;
  color: #cbd5e1;
  text-decoration: none;
  border-radius: 8px;
  transition: 0.2s;
  cursor: pointer;
}
.sidebar a:hover,
.sidebar a.active {
  background: #2563eb;
  color: white;
  transform: scale(1.03);
}

/* Topbar */
.topbar {
  background: #1976d2;
  color: white;
  padding: 0.75rem 1.25rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 999;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  border-bottom-left-radius: 5px;
  border-bottom-right-radius: 5px;
  flex-wrap: wrap;
}

/* Contenido principal */
.content {
  margin-left: 250px;
  padding: 1.5rem;
  transition: margin-left 0.3s;
}
.content.collapsed { margin-left: 70px; }

/* Cards y Stat cards */
.card-box {
  background: white;
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 4px 15px rgba(0,0,0,.05);
  margin-bottom: 25px;
  transition: transform 0.2s;
}
.card-box:hover { transform: translateY(-3px); }

.stat-card, .card-stat {
  border-radius: 15px;
  padding: 20px;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}
.stat-card:hover, .card-stat:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

/* Colores */
.bg1 { background: linear-gradient(135deg,#0d3b66,#07407c); }
.bg2 { background: linear-gradient(135deg,#6c757d,#5a6268); }
.bg3 { background: linear-gradient(135deg,#0d6efd,#025ce2); }
.bg4 { background: linear-gradient(135deg,#d63384,#b52a6f); }
.bg5 { background: linear-gradient(135deg,#198754,#146c43); }
.bg6 { background: linear-gradient(135deg,#fd7e14,#e76f00); }

/* Secciones */
.section { display: none; }
.section.active { display: block; }

/* Grid de cards */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
  gap: 1.5rem;
}

/* Tables */
.table-responsive {
  overflow-x: auto;
}

/* Responsive general */
@media (max-width:1024px) {
  .sidebar { width: 200px; }
  .content { margin-left: 200px; }
}

@media (max-width:768px) {
  .sidebar {
    width: 60px;
    overflow-x: hidden;
    position: fixed;
    left: 0;
    top: 0;
    height: 100%;
    transition: width 0.3s;
  }
  .sidebar:hover { width: 180px; }
  .sidebar.show { width: 180px; }
  .content { margin-left: 60px; padding: 1rem; }
}

@media (max-width:480px) {
  .sidebar {
    width: 0;
    transition: width 0.3s;
  }
  .sidebar.show { width: 180px; }
  .content { margin-left: 0; padding: 0.75rem; }
  .topbar { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
  .card-box, .stat-card, .card-stat { padding: 15px; }
  .cards-grid { gap: 1rem; }
  h2 { font-size: 1.5rem; }
  h4, h6 { font-size: 0.9rem; }
}

/* Evita overflow horizontal */
body { overflow-x: hidden; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
<h5 class="text-center py-3">Plus Laboratorio Clinico Cartagena</h5>

<a class="active" onclick="showSection('dashboard',this)">
<i class="bi bi-speedometer2"></i> Dashboard
</a>

<a onclick="showSection('citas',this)">
<i class="bi bi-calendar-event"></i> Listado de Citas
</a>

<a onclick="showSection('resultados',this)">
<i class="bi bi-file-earmark-medical"></i> Resultados de Pruebas
</a>

<a href="../api/logout.php" onclick="logout()">
<i class="bi bi-box-arrow-right"></i> Salir
</a>

</div>

<!-- CONTENIDO -->
<div class="content">

<div class="topbar">
<div>Plus Laboratorio Clínico Cartagena</div>
<div>Paciente</div>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard" class="section active mt-4">

<h2>Bienvenido(a)</h2>
<hr>

<div class="row g-4 mt-3">

<div class="col-md-3">
<div class="card-stat bg1">
<div>
<h6>Citas Reservadas</h6>
<h4 id="reservadas">0</h4>
</div>
<i class="bi bi-calendar-event fs-1"></i>
</div>
</div>

<div class="col-md-3">
<div class="card-stat bg2">
<div>
<h6>Citas Pendientes</h6>
<h4 id="pendientes">0</h4>
</div>
<i class="bi bi-hourglass-split fs-1"></i>
</div>
</div>

<div class="col-md-3">
<div class="card-stat bg3">
<div>
<h6>Citas Aprobadas</h6>
<h4 id="aprobadas">0</h4>
</div>
<i class="bi bi-hand-thumbs-up fs-1"></i>
</div>
</div>

<div class="col-md-3">
<div class="card-stat bg4">
<div>
<h6>Pruebas Terminadas</h6>
<h4 id="terminadas">0</h4>
</div>
<i class="bi bi-clipboard2-pulse fs-1"></i>
</div>
</div>

</div>
</div>

<!-- ================= CITAS ================= -->
<div id="citas" class="section mt-4">
<div class="card-box">
<h4>Mis Citas</h4>

<table class="table table-responsive mt-3">
<thead>
<tr>
<th>Fecha</th>
<th>Hora</th>
<th>Estado</th>
</tr>
</thead>
<tbody id="tablaCitas"></tbody>
</table>

</div>
</div>

<!-- ================= RESULTADOS ================= -->
<div id="resultados" class="section mt-4">

<div class="card-box" id="contenedorResultadosPDF">
<h4>Resultados de Pruebas</h4>

<table class="table table-responsive mt-3">
<thead>
<tr>
<th>Prueba</th>
<th>Fecha</th>
<th>Valor</th>
<th>Estado</th>
</tr>
</thead>
<tbody id="tablaResultados"></tbody>
</table>

<button class="btn btn-danger mt-3" onclick="exportarPDF()">
<i class="bi bi-file-earmark-pdf"></i> Descargar PDF
</button>

</div>
</div>

</div>

<script>

/* Logout sesion */

async function logout(){
    await fetch("../api/logout.php",{
        method:"POST",
        credentials:"include"
    });
    window.location.href="../login.html";
}


/* ================= NAVEGACIÓN ================= */

function showSection(id,el){
document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");

document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
el.classList.add("active");
}

/* ================= DASHBOARD ================= */

async function cargarDashboard(){
const res=await fetch("../api/paciente_dashboard.php",{credentials:"include"});
if(!res.ok){location.href="../login.html";return;}
const data=await res.json();

reservadas.innerText=data.reservadas||0;
pendientes.innerText=data.pendientes||0;
aprobadas.innerText=data.aprobadas||0;
terminadas.innerText=data.terminadas||0;
}

/* ================= CITAS ================= */

async function cargarCitas(){
const res=await fetch("../api/get_citas_paciente.php",{credentials:"include"});
if(!res.ok)return;
const data=await res.json();

tablaCitas.innerHTML=data.map(c=>`
<tr>
<td>${c.fecha}</td>
<td>${c.hora}</td>
<td>${c.estado}</td>
</tr>
`).join("");
}

/* ================= RESULTADOS ================= */

function evaluarEstado(prueba,valor){
valor=parseFloat(valor);
if(prueba.toLowerCase().includes("glucosa") && valor>140) return "Crítico";
if(prueba.toLowerCase().includes("colesterol") && valor>240) return "Crítico";
return "Normal";
}

async function cargarResultados(){
const res=await fetch("../api/get_resultados.php",{credentials:"include"});
if(!res.ok)return;
const data=await res.json();

tablaResultados.innerHTML=data.map(r=>{
const estado=evaluarEstado(r.prueba,r.valor);
return `
<tr>
<td>${r.prueba}</td>
<td>${r.fecha}</td>
<td style="${estado==='Crítico'?'color:red;font-weight:bold':''}">
${r.valor}
</td>
<td>
<span class="badge ${estado==='Crítico'?'bg-danger':'bg-success'}">
${estado}
</span>
</td>
</tr>
`;
}).join("");
}

/* ================= PDF ================= */

function exportarPDF(){
html2pdf().from(document.getElementById("contenedorResultadosPDF"))
.set({filename:"resultados_paciente.pdf"})
.save();
}

/* ================= INIT ================= */

document.addEventListener("DOMContentLoaded",()=>{
cargarDashboard();
cargarCitas();
cargarResultados();
});
</script>

</body>
</html>
