<?php
session_start();
if(!isset($_SESSION['user']) || $_SESSION['user']['rol'] !== 'paciente'){
    header("Location: ../login.html");
    exit;
}
?>

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="/assets/images/PLUS.png"
      type="image/x-icon"
    />
    <title>Laboratorio - Paciente</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      /* =========================
   RESET
   ========================= */

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, sans-serif;
        background: #f4f6f9;
        font-size: 16px;
        color: #333;
        overflow-x: hidden;
        transition: 0.3s ease;
      }

      body.menu-open {
        overflow: hidden;
      }

      /* =========================
   SIDEBAR
   ========================= */

      .sidebar {
        width: 250px;
        background: #0f172a;
        color: white;
        min-height: 100vh;
        position: fixed;
        display: flex;
        flex-direction: column;
        transition: 0.3s ease;
        z-index: 1000;
      }

      .sidebar h5 {
        padding: 1.25rem;
        text-align: center;
        border-bottom: 1px solid #1e293b;
        font-weight: 700;
        letter-spacing: 1px;
      }

      .sidebar a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0.875rem 1.25rem;
        color: #cbd5e1;
        text-decoration: none;
        border-radius: 8px;
        transition: 0.2s ease;
      }

      .sidebar a:hover,
      .sidebar a.active {
        background: #2563eb;
        color: white;
        transform: translateX(4px);
      }

      /* =========================
   TOPBAR
   ========================= */

      .topbar {
        background: #1976d2;
        color: white;
        padding: 0.75rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 999;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      /* =========================
   BOTÓN HAMBURGUESA
   ========================= */

      .menu-toggle {
        width: 40px;
        height: 40px;
        display: none;
        flex-direction: column;
        justify-content: center;
        gap: 6px;
        background: transparent;
        border: none;
        cursor: pointer;
      }

      .menu-toggle span {
        height: 3px;
        width: 25px;
        background: white;
        border-radius: 3px;
        transition: 0.3s ease;
      }

      .menu-toggle.active span:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px);
      }
      .menu-toggle.active span:nth-child(2) {
        opacity: 0;
      }
      .menu-toggle.active span:nth-child(3) {
        transform: rotate(-45deg) translate(6px, -6px);
      }

      /* =========================
   OVERLAY
   ========================= */

      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(2px);
        opacity: 0;
        visibility: hidden;
        transition: 0.3s ease;
        z-index: 900;
      }

      .overlay.show {
        opacity: 1;
        visibility: visible;
      }

      /* =========================
   CONTENT
   ========================= */

      .content {
        margin-left: 250px;
        padding: 1.5rem;
        transition: 0.3s ease;
      }

      /* =========================
   CARDS
   ========================= */

      .card-box {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
        transition: 0.2s ease;
      }

      .card-box:hover {
        transform: translateY(-3px);
      }

      .stat-card {
        border-radius: 15px;
        padding: 20px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: 0.2s ease;
        margin-bottom: 20px;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }

      /* =========================
   COLORES
   ========================= */

      .bg1 {
        background: linear-gradient(135deg, #0d3b66, #07407c);
      }
      .bg2 {
        background: linear-gradient(135deg, #6c757d, #5a6268);
      }
      .bg3 {
        background: linear-gradient(135deg, #0d6efd, #025ce2);
      }
      .bg4 {
        background: linear-gradient(135deg, #198754, #146c43);
      }
      .bg5 {
        background: linear-gradient(135deg, #d63384, #b52a6f);
      }
      .bg6 {
        background: linear-gradient(135deg, #fd7e14, #e76f00);
      }

      /* =========================
   GRID
   ========================= */

      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }

      /* =========================
   SECCIONES
   ========================= */

      .section {
        display: none;
      }
      .section.active {
        display: block;
      }

      /* =========================
   RESPONSIVE
   ========================= */

      @media (max-width: 1024px) {
        .sidebar {
          width: 200px;
        }
        .content {
          margin-left: 200px;
        }
      }

      @media (max-width: 768px) {
        .menu-toggle {
          display: flex;
        }

        .sidebar {
          width: 0;
          overflow: hidden;
        }

        .sidebar.show {
          width: 240px;
        }

        .content {
          margin-left: 0;
          padding: 1rem;
        }

        .stat-card {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .cards-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        body {
          font-size: 14px;
        }

        .topbar {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .card-box {
          padding: 16px;
        }

        .stat-card {
          padding: 15px;
        }
      }
    </style>
  </head>

  <body>
    <div class="sidebar">
      <h5>Plus Laboratorio</h5>

      <a class="active" onclick="showSection('dashboard', this)">
        <i class="bi bi-speedometer2"></i> Dashboard
      </a>

      <a onclick="showSection('citas', this)">
        <i class="bi bi-calendar-event"></i> Mis Citas
      </a>

      <a onclick="showSection('resultados', this)">
        <i class="bi bi-file-earmark-medical"></i> Resultados
      </a>

      <a
        href="#"
        onclick="
          logout();
          return false;
        "
      >
        <i class="bi bi-box-arrow-right"></i> Salir
      </a>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="content">
      <div class="topbar">
        <div>Plus Laboratorio Clínico Cartagena</div>
        <div>
          Bienvenido, <?php echo htmlspecialchars($_SESSION['user']['nombre']);
          ?>
        </div>

        <button class="menu-toggle" id="menuToggle">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>

      <!-- DASHBOARD -->
      <div id="dashboard" class="section active">
        <h2 class="mt-3">Mi Panel</h2>
        <hr />

        <div class="row mt-4">
          <div class="col-md-3">
            <div class="stat-card bg1">
              <div>
                <h6>Citas Reservadas</h6>
                <h4 id="reservadas">0</h4>
              </div>
              <i class="bi bi-calendar-event fs-1"></i>
            </div>
          </div>

          <div class="col-md-3">
            <div class="stat-card bg2">
              <div>
                <h6>Pendientes</h6>
                <h4 id="pendientes">0</h4>
              </div>
              <i class="bi bi-hourglass-split fs-1"></i>
            </div>
          </div>

          <div class="col-md-3">
            <div class="stat-card bg3">
              <div>
                <h6>Aprobadas</h6>
                <h4 id="aprobadas">0</h4>
              </div>
              <i class="bi bi-hand-thumbs-up fs-1"></i>
            </div>
          </div>

          <div class="col-md-3">
            <div class="stat-card bg4">
              <div>
                <h6>Pruebas Terminadas</h6>
                <h4 id="terminadas">0</h4>
              </div>
              <i class="bi bi-check-circle fs-1"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- CITAS -->
      <div id="citas" class="section mt-4">
        <div class="card shadow-sm">
          <!-- Header -->

          <div class="card-header bg-white py-3">
            <div
              class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3"
            >
              <!-- Título -->
              <div>
                <h5 class="mb-0 fw-semibold">
                  <i class="bi bi-calendar-event me-2 text-primary"></i>
                  Lista de Citas Reservadas
                </h5>
                <small class="text-muted"
                  >Gestiona y consulta tus citas fácilmente</small
                >
              </div>

              <!-- Acciones -->
              <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-lg-auto">
                <!-- Buscador -->
                <div class="position-relative flex-grow-1">
                  <i
                    class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"
                  ></i>
                  <input
                    type="text"
                    id="buscadorCitas"
                    class="form-control form-control-sm ps-5 rounded-pill"
                    placeholder="Buscar por código, fecha o estado..."
                  />
                </div>

                <!-- Botón actualizar -->
                <button class="btn btn-outline-secondary btn-sm px-3">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>

                <!-- Botón principal 
                <button
                  class="btn btn-primary btn-sm px-3 shadow-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#modalNuevaCita"
                >
                  <i class="bi bi-plus-lg me-1"></i>
                  Nueva Prueba
                </button>-->

                
              </div>
            </div>
          </div>

          <!-- Body -->
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover align-middle">
                <thead class="table-primary text-center">
                  <tr>
                    <th>#</th>
                    <th>Fecha de Creación</th>
                    <th>Codigo</th>
                    <th>Paciente</th>
                    <th>Examen</th>
                    <th>Estado</th>
                    <th>Accion</th>
                  </tr>
                </thead>

                <tbody id="tablaCitas">
                  <tr>
                    <td class="text-center">1</td>
                    <td>2025-06-10 10:30</td>
                    <td>202506-0001</td>
                    <td>Juan Pérez</td>
                    <td>Ecografía</td>
                    <td class="text-center">
                      <span class="badge bg-success rounded-pill"
                        >Finalizado</span
                      >
                    </td>
                    <td class="text-center accion-cell">
                      <div class="dropdown accion-dropdown">
                        <button
                          class="btn btn-sm btn-outline-secondary accion-btn dropdown-toggle"
                          type="button"
                          data-bs-toggle="dropdown"
                        >
                          <i class="bi bi-three-dots-vertical"></i>
                          <span class="accion-text">Acción</span>
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                          <li>
                            <a class="dropdown-item" href="#"
                              ><i class="bi bi-eye me-2"></i>Ver</a
                            >
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- RESULTADOS -->
      <div id="resultados" class="section mt-4">
        <div class="card shadow-sm">
          <!-- Header -->
          <div
            class="card-header bg-white d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0">Lista de Resultados</h5>

            <div class="d-flex gap-2">
              <input
                type="text"
                id="buscadorResultados"
                class="form-control form-control-sm"
                placeholder="Buscar resultado..."
              />
              <button class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>

          <!-- Body -->
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover align-middle">
                <thead class="table-primary text-center">
                  <tr>
                    <th>#</th>
                    <th>Fecha</th>
                    <th>Código</th>
                    <th>Paciente</th>
                    <th>Examen</th>
                    <th>Resultado</th>
                    <th>Acción</th>
                  </tr>
                </thead>

                <tbody id="tablaResultados">
                  <tr>
                    <td class="text-center">1</td>
                    <td>2025-06-10 10:30</td>
                    <td>202506-0001</td>
                    <td>Juan Pérez</td>
                    <td>Ecografía</td>
                    <td class="text-center">
                      <span class="badge bg-success rounded-pill">
                        Disponible
                      </span>
                    </td>
                    <td class="text-center">
                      <button
                        class="btn btn-danger btn-sm"
                        id="btnDescargar"
                        onclick="exportarPDF('202506-0001')"
                        class="bi bi-file-earmark-pdf"
                      >
                        <i class="bi bi-file-earmark-pdf"></i> Descargar
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document
        .getElementById("buscadorResultados")
        .addEventListener("keyup", function () {
          let filtro = this.value.toLowerCase();
          let filas = document.querySelectorAll("#tablaResultados tr");

          filas.forEach((fila) => {
            let textoFila = fila.textContent.toLowerCase();
            fila.style.display = textoFila.includes(filtro) ? "" : "none";
          });
        });
    </script>

    <script>

      /* Paciente */

      async function cargarCitasPaciente() {
  const res = await fetch("../api/paciente/get_mis_citas.php");
  const data = await res.json();

  const tabla = document.getElementById("tablaMisCitas");

  tabla.innerHTML = data.map((c, index) => `
    <tr>
      <td>${index + 1}</td>
      <td>${c.fecha}</td>
      <td>${c.prueba}</td>
      <td>
        <span class="badge bg-${c.estado === 'Pendiente' ? 'warning' : 'success'}">
          ${c.estado}
        </span>
      </td>
    </tr>
  `).join("");
}

      /* Menu Type Hamburguesa */
      const toggleBtn = document.getElementById("menuToggle");
      const sidebar = document.querySelector(".sidebar");
      const overlay = document.getElementById("overlay");

      toggleBtn.addEventListener("click", () => {
        sidebar.classList.toggle("show");
        overlay.classList.toggle("show");
        toggleBtn.classList.toggle("active");
        document.body.classList.toggle("menu-open");
      });

      overlay.addEventListener("click", () => {
        sidebar.classList.remove("show");
        overlay.classList.remove("show");
        toggleBtn.classList.remove("active");
        document.body.classList.remove("menu-open");
      });

      /* Navegación */
      function showSection(id, el) {
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        document
          .querySelectorAll(".sidebar a")
          .forEach((a) => a.classList.remove("active"));
        el.classList.add("active");
      }

      /* Logout */
      async function logout() {
        await fetch("../api/logout.php", {
          method: "POST",
          credentials: "include",
        });
        window.location.href = "../login.html";
      }

      /* Dashboard */
      async function cargarDashboard() {
        const res = await fetch("../api/paciente_dashboard.php", {
          credentials: "include",
        });
        if (!res.ok) return;
        const data = await res.json();
        reservadas.innerText = data.reservadas || 0;
        pendientes.innerText = data.pendientes || 0;
        aprobadas.innerText = data.aprobadas || 0;
        terminadas.innerText = data.terminadas || 0;
      }

      /* Citas */
      async function cargarCitas() {
        const res = await fetch("../api/get_citas_paciente.php", {
          credentials: "include",
        });
        if (!res.ok) return;
        const data = await res.json();
        tablaCitas.innerHTML = data
          .map(
            (c) => `
<tr>
<td>${c.fecha}</td>
<td>${c.hora}</td>
<td>${c.estado}</td>
</tr>
`,
          )
          .join("");
      }

      /* Resultados */
      function evaluarEstado(prueba, valor) {
        valor = parseFloat(valor);
        if (prueba.toLowerCase().includes("glucosa") && valor > 140)
          return "Crítico";
        if (prueba.toLowerCase().includes("colesterol") && valor > 240)
          return "Crítico";
        return "Normal";
      }

      async function cargarResultados() {
        const res = await fetch("../api/get_resultados.php", {
          credentials: "include",
        });
        if (!res.ok) return;
        const data = await res.json();
        tablaResultados.innerHTML = data
          .map((r) => {
            const estado = evaluarEstado(r.prueba, r.valor);
            return `
<tr>
<td>${r.prueba}</td>
<td>${r.fecha}</td>
<td style="${estado === "Crítico" ? "color:red;font-weight:bold" : ""}">
${r.valor}
</td>
<td>
<span class="badge ${estado === "Crítico" ? "bg-danger" : "bg-success"}">
${estado}
</span>
</td>
</tr>`;
          })
          .join("");
      }

      document.addEventListener("DOMContentLoaded", () => {
        cargarDashboard();
        cargarCitas();
        cargarResultados();
      });

      /* Resultados PDF */

      function exportarPDF() {
        const element = document.getElementById("contenedorResultadosPDF");

        const opt = {
          margin: 0.5,
          filename: "resultados_laboratorio.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };

        html2pdf().set(opt).from(element).save();
      }

      /* Cargar resultados */

      async function cargarResultados() {
        const res = await fetch("../api/get_resultados.php", {
          credentials: "include",
        });
        if (!res.ok) return;

        const data = await res.json();
        let hayCritico = false;

        tablaResultados.innerHTML = data
          .map((r) => {
            const estado = evaluarEstado(r.prueba, r.valor);
            if (estado === "Crítico") hayCritico = true;

            return `
<tr>
<td>${r.prueba}</td>
<td>${r.fecha}</td>
<td style="${estado === "Crítico" ? "color:red;font-weight:bold" : ""}">
${r.valor}
</td>
<td>
<span class="badge ${estado === "Crítico" ? "bg-danger" : "bg-success"}">
${estado}
</span>
</td>
</tr>`;
          })
          .join("");

        if (hayCritico) {
          alertaCritico.classList.remove("d-none");
        } else {
          alertaCritico.classList.add("d-none");
        }
      }

      /* =========================
   BUSCADOR ACTIVO CITAS
========================= */

      const buscadorCitas = document.getElementById("buscadorCitas");
      const tablaCitas = document.getElementById("tablaCitas");

      let debounceTimer;

      buscadorCitas.addEventListener("input", function () {
        clearTimeout(debounceTimer);

        debounceTimer = setTimeout(() => {
          const filtro = this.value.toLowerCase().trim();
          const filas = tablaCitas.querySelectorAll("tr");

          let coincidencias = 0;

          filas.forEach((fila) => {
            const texto = fila.textContent.toLowerCase();

            if (texto.includes(filtro)) {
              fila.style.display = "";
              coincidencias++;
            } else {
              fila.style.display = "none";
            }
          });

          mostrarEstadoVacio(coincidencias, filtro);
        }, 200); // debounce 200ms
      });

      /* Estado vacío inteligente */
      function mostrarEstadoVacio(total, filtro) {
        let estadoVacio = document.getElementById("estadoVacioCitas");

        if (total === 0 && filtro !== "") {
          if (!estadoVacio) {
            estadoVacio = document.createElement("tr");
            estadoVacio.id = "estadoVacioCitas";
            estadoVacio.innerHTML = `
        <td colspan="7">
          <div class="empty-state">
            <i class="bi bi-search fs-1"></i>
            <p class="mt-2 mb-0">No se encontraron coincidencias</p>
          </div>
        </td>
      `;
            tablaCitas.appendChild(estadoVacio);
          }
        } else {
          if (estadoVacio) estadoVacio.remove();
        }
      }

      /* =========================
   DESCARGAR RESULTADOS FILTRADOS
========================= */

      const btnDescargar = document.getElementById("btnDescargar");
      const tabla = document.getElementById("tablaCitas");

      btnDescargar.addEventListener("click", function () {
        const filasVisibles = [...tabla.querySelectorAll("tr")].filter(
          (fila) => fila.style.display !== "none",
        );

        if (filasVisibles.length === 0) {
          alert("No hay resultados para descargar.");
          return;
        }

        let csv = [];

        filasVisibles.forEach((fila) => {
          const columnas = fila.querySelectorAll("td");
          const filaData = [];

          columnas.forEach((col) => {
            filaData.push(`"${col.innerText.trim()}"`);
          });

          csv.push(filaData.join(","));
        });

        const blob = new Blob([csv.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "resultados_filtrados.csv";
        link.click();

        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
