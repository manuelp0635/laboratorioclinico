<?php
session_start();
if(!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'paciente'){
    header("Location: ../login.html");
    exit;
}
?>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laboratorio | Paciente</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
margin:0;
font-family:system-ui;
background:#f4f6f9;
}

.sidebar{
width:250px;
background:#0f172a;
color:#fff;
min-height:100vh;
position:fixed;
}

.sidebar a{
display:block;
padding:14px 20px;
color:#cbd5e1;
text-decoration:none;
cursor:pointer;
}

.sidebar a:hover,
.sidebar .active{
background:#2563eb;
color:white;
}

.topbar{
background:#1976d2;
color:white;
padding:15px 20px;
display:flex;
justify-content:space-between;
align-items:center;
position:sticky;
top:0;
}

.content{
margin-left:250px;
padding:25px;
}

.section{
display:none;
}

.section.active{
display:block;
}

.card-stat{
border-radius:15px;
padding:20px;
color:white;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:0 5px 15px rgba(0,0,0,.1);
}

.bg1{background:#0d3b66}
.bg2{background:#6c757d}
.bg3{background:#0d6efd}
.bg4{background:#d63384}

.card-box{
background:white;
border-radius:15px;
padding:20px;
box-shadow:0 5px 15px rgba(0,0,0,.05);
}

@media(max-width:992px){
.content{margin-left:0}
.sidebar{position:absolute;z-index:1000}
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
<h5 class="text-center py-3">Plus Laboratorio Clinico Cartagena</h5>

<a class="active" onclick="showSection('dashboard',this)">
<i class="bi bi-speedometer2"></i> Dashboard
</a>

<a onclick="showSection('citas',this)">
<i class="bi bi-calendar-event"></i> Listado de Citas
</a>

<a onclick="showSection('resultados',this)">
<i class="bi bi-file-earmark-medical"></i> Resultados de Pruebas
</a>

<a href="../api/logout.php" onclick="logout()">
<i class="bi bi-box-arrow-right"></i> Salir
</a>

</div>

<!-- CONTENIDO -->
<div class="content">

<div class="topbar">
<div>Laboratorio de Diagnóstico en Línea</div>
<div>Paciente</div>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard" class="section active mt-4">

<h2>Bienvenido(a)</h2>
<hr>

<div class="row g-4 mt-3">

<div class="col-md-3">
<div class="card-stat bg1">
<div>
<h6>Citas Reservadas</h6>
<h4 id="reservadas">0</h4>
</div>
<i class="bi bi-calendar-event fs-1"></i>
</div>
</div>

<div class="col-md-3">
<div class="card-stat bg2">
<div>
<h6>Citas Pendientes</h6>
<h4 id="pendientes">0</h4>
</div>
<i class="bi bi-hourglass-split fs-1"></i>
</div>
</div>

<div class="col-md-3">
<div class="card-stat bg3">
<div>
<h6>Citas Aprobadas</h6>
<h4 id="aprobadas">0</h4>
</div>
<i class="bi bi-hand-thumbs-up fs-1"></i>
</div>
</div>

<div class="col-md-3">
<div class="card-stat bg4">
<div>
<h6>Pruebas Terminadas</h6>
<h4 id="terminadas">0</h4>
</div>
<i class="bi bi-clipboard2-pulse fs-1"></i>
</div>
</div>

</div>
</div>

<!-- ================= CITAS ================= -->
<div id="citas" class="section mt-4">
<div class="card-box">
<h4>Mis Citas</h4>

<table class="table table-responsive mt-3">
<thead>
<tr>
<th>Fecha</th>
<th>Hora</th>
<th>Estado</th>
</tr>
</thead>
<tbody id="tablaCitas"></tbody>
</table>

</div>
</div>

<!-- ================= RESULTADOS ================= -->
<div id="resultados" class="section mt-4">

<div class="card-box" id="contenedorResultadosPDF">
<h4>Resultados de Pruebas</h4>

<table class="table table-responsive mt-3">
<thead>
<tr>
<th>Prueba</th>
<th>Fecha</th>
<th>Valor</th>
<th>Estado</th>
</tr>
</thead>
<tbody id="tablaResultados"></tbody>
</table>

<button class="btn btn-danger mt-3" onclick="exportarPDF()">
<i class="bi bi-file-earmark-pdf"></i> Descargar PDF
</button>

</div>
</div>

</div>

<script>

/* Logout sesion */

async function logout(){
    await fetch("../api/logout.php",{
        method:"POST",
        credentials:"include"
    });
    window.location.href="../login.html";
}


/* ================= NAVEGACIÓN ================= */

function showSection(id,el){
document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");

document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
el.classList.add("active");
}

/* ================= DASHBOARD ================= */

async function cargarDashboard(){
const res=await fetch("../api/paciente_dashboard.php",{credentials:"include"});
if(!res.ok){location.href="../login.html";return;}
const data=await res.json();

reservadas.innerText=data.reservadas||0;
pendientes.innerText=data.pendientes||0;
aprobadas.innerText=data.aprobadas||0;
terminadas.innerText=data.terminadas||0;
}

/* ================= CITAS ================= */

async function cargarCitas(){
const res=await fetch("../api/get_citas_paciente.php",{credentials:"include"});
if(!res.ok)return;
const data=await res.json();

tablaCitas.innerHTML=data.map(c=>`
<tr>
<td>${c.fecha}</td>
<td>${c.hora}</td>
<td>${c.estado}</td>
</tr>
`).join("");
}

/* ================= RESULTADOS ================= */

function evaluarEstado(prueba,valor){
valor=parseFloat(valor);
if(prueba.toLowerCase().includes("glucosa") && valor>140) return "Crítico";
if(prueba.toLowerCase().includes("colesterol") && valor>240) return "Crítico";
return "Normal";
}

async function cargarResultados(){
const res=await fetch("../api/get_resultados.php",{credentials:"include"});
if(!res.ok)return;
const data=await res.json();

tablaResultados.innerHTML=data.map(r=>{
const estado=evaluarEstado(r.prueba,r.valor);
return `
<tr>
<td>${r.prueba}</td>
<td>${r.fecha}</td>
<td style="${estado==='Crítico'?'color:red;font-weight:bold':''}">
${r.valor}
</td>
<td>
<span class="badge ${estado==='Crítico'?'bg-danger':'bg-success'}">
${estado}
</span>
</td>
</tr>
`;
}).join("");
}

/* ================= PDF ================= */

function exportarPDF(){
html2pdf().from(document.getElementById("contenedorResultadosPDF"))
.set({filename:"resultados_paciente.pdf"})
.save();
}

/* ================= INIT ================= */

document.addEventListener("DOMContentLoaded",()=>{
cargarDashboard();
cargarCitas();
cargarResultados();
});
</script>

</body>
</html>
